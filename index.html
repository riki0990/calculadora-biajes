<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora Uber Optimizada</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --secondary: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --success: #22c55e;
            --light: #f8fafc;
            --dark: #1e293b;
            --gray: #64748b;
            --light-gray: #e2e8f0;
            --border-radius: 12px;
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: var(--dark);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            width: 100%;
            max-width: 1100px;
            overflow: hidden;
        }

        header {
            background: var(--primary);
            color: white;
            padding: 20px;
            text-align: center;
        }

        h1 {
            font-size: 24px;
            margin: 0;
        }

        .app-content {
            padding: 20px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .panel {
            background: var(--light);
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        h2 {
            color: var(--primary);
            margin-bottom: 15px;
            font-size: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--light-gray);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--gray);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        input, select {
            width: 100%;
            padding: 12px 14px;
            border: 2px solid var(--light-gray);
            border-radius: 8px;
            font-size: 16px;
            transition: var(--transition);
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
        }

        input[readonly] {
            background-color: #f3f4f6;
            color: #4b5563;
            cursor: not-allowed;
        }

        button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 18px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            width: 100%;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        button:hover {
            background: var(--primary-dark);
        }

        .btn-danger {
            background: var(--danger);
        }

        .btn-success {
            background: var(--success);
        }

        .btn-warning {
            background: var(--warning);
        }

        .btn-secondary {
            background: var(--gray);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin: 15px 0;
        }

        .stat-card {
            background: white;
            padding: 15px;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            text-align: center;
            border-left: 4px solid var(--primary);
        }

        .stat-value {
            font-size: 20px;
            font-weight: bold;
            color: var(--primary);
            margin: 8px 0;
        }

        .stat-label {
            font-size: 13px;
            color: var(--gray);
        }

        .progress-container {
            margin: 20px 0;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .progress-bar {
            height: 20px;
            background-color: var(--light-gray);
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            border-radius: 10px;
            transition: width 0.5s ease-in-out;
            position: relative;
        }

        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-weight: 700;
            font-size: 11px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }

        .saldo-display {
            background: #f0f9ff;
            border: 1px solid var(--primary);
            border-radius: var(--border-radius);
            padding: 10px;
            margin: 10px 0;
            text-align: center;
        }

        .saldo-label {
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 5px;
        }

        .saldo-value {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary);
        }

        .next-trip {
            background: #fffbeb;
            border: 2px dashed var(--warning);
            border-radius: var(--border-radius);
            padding: 15px;
            margin: 15px 0;
            text-align: center;
        }

        .next-trip-title {
            color: var(--warning);
            font-weight: 700;
            margin-bottom: 8px;
        }

        .next-trip-amount {
            font-size: 24px;
            font-weight: 800;
            color: var(--warning);
            margin: 8px 0;
        }

        .trip-list {
            margin-top: 15px;
            max-height: 200px;
            overflow-y: auto;
            padding-right: 8px;
        }

        .trip-item {
            display: flex;
            justify-content: space-between;
            padding: 12px;
            background: white;
            border-radius: var(--border-radius);
            margin-bottom: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            border-left: 4px solid var(--primary);
        }

        .trip-info {
            display: flex;
            flex-direction: column;
        }

        .trip-number {
            font-weight: 700;
            color: var(--gray);
        }

        .trip-time {
            font-size: 11px;
            color: var(--gray);
        }

        .trip-amount {
            font-weight: 700;
            color: var(--success);
            font-size: 16px;
        }

        .equivalent-notification {
            background: #fffbeb;
            border: 1px solid var(--warning);
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
            text-align: center;
            display: none;
        }

        .progress-details {
            font-size: 12px;
            color: var(--gray);
            margin-top: 5px;
            text-align: center;
        }

        .calculated-results {
            background: #f0f9ff;
            border-radius: var(--border-radius);
            padding: 15px;
            margin: 15px 0;
            border: 1px solid var(--primary);
        }

        .calculated-title {
            text-align: center;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 10px;
        }

        .monthly-plan {
            background: #f0f9ff;
            border-radius: var(--border-radius);
            padding: 15px;
            margin: 15px 0;
            border: 1px solid var(--primary);
        }

        .monthly-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .month-selector {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .month-selector button {
            width: auto;
            padding: 8px 12px;
        }

        .calendar-container {
            margin-top: 15px;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }

        .calendar-header {
            text-align: center;
            font-weight: bold;
            padding: 8px 0;
            color: var(--primary);
            font-size: 14px;
        }

        .calendar-day {
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            font-size: 14px;
        }

        .calendar-day:hover {
            background-color: var(--light-gray);
        }

        .calendar-day.workday {
            background-color: white;
        }

        .calendar-day.restday {
            background-color: #fee2e2;
            color: var(--danger);
            font-weight: bold;
        }

        .calendar-day.today {
            border: 2px solid var(--primary);
        }

        .calendar-day.meta-alcanzada {
            background-color: var(--success);
            color: white;
        }

        .calendar-day.meta-no-alcanzada {
            background-color: var(--danger);
            color: white;
        }

        .calendar-day.other-month {
            color: #ccc;
            cursor: default;
        }

        .calendar-day.past-day {
            opacity: 0.6;
            background-color: #f3f4f6;
        }

        .calendar-day.past-day.workday {
            background-color: #f3f4f6;
        }

        .calendar-day.past-day.restday {
            background-color: #fee2e2;
            opacity: 0.7;
        }

        .monthly-summary {
            margin-top: 15px;
            padding: 10px;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .tabs {
            display: flex;
            margin-bottom: 15px;
            border-bottom: 1px solid var(--light-gray);
        }

        .tab {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
        }

        .tab.active {
            border-bottom: 3px solid var(--primary);
            font-weight: bold;
            color: var(--primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .day-status {
            position: absolute;
            bottom: 2px;
            right: 2px;
            font-size: 8px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: white;
            padding: 25px;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--light-gray);
        }

        .modal-title {
            font-size: 20px;
            font-weight: bold;
            color: var(--primary);
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--gray);
            width: auto;
            padding: 0;
        }

        .close-modal:hover {
            color: var(--danger);
        }

        .resumen-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 8px 0;
            border-bottom: 1px dashed var(--light-gray);
        }

        .resumen-label {
            font-weight: 600;
            color: var(--gray);
        }

        .resumen-value {
            font-weight: 700;
            color: var(--dark);
        }

        .resumen-destacado {
            background-color: #f0f9ff;
            padding: 12px;
            border-radius: var(--border-radius);
            margin: 15px 0;
            border-left: 4px solid var(--primary);
        }

        .resumen-destacado .resumen-label {
            color: var(--primary);
        }

        .auto-finish-notification {
            background: #fef3c7;
            border: 1px solid var(--warning);
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
            text-align: center;
            display: none;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            z-index: 10000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            max-width: 300px;
            transition: all 0.3s ease;
            transform: translateX(100%);
            opacity: 0;
        }

        .notification.show {
            transform: translateX(0);
            opacity: 1;
        }

        .notification-success {
            background: var(--success);
        }

        .notification-error {
            background: var(--danger);
        }

        .notification-warning {
            background: var(--warning);
        }

        .notification-content {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .notification-close {
            background: none;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            margin-left: 10px;
        }

        @media (max-width: 968px) {
            .app-content {
                grid-template-columns: 1fr;
            }
            
            .monthly-header {
                flex-direction: column;
                align-items: stretch;
            }
            
            .month-selector {
                justify-content: center;
            }
            
            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 10px;
            }
            
            .container {
                border-radius: 8px;
            }
            
            .panel {
                padding: 15px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .calendar-day {
                height: 30px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-taxi"></i> Calculadora de Meta Diaria y Mensual</h1>
        </header>
        
        <div class="app-content">
            <div class="panel">
                <h2><i class="fas fa-cog"></i> Configuración</h2>
                
                <div class="monthly-plan">
                    <h3><i class="fas fa-calendar-alt"></i> Planificación Mensual</h3>
                    
                    <div class="form-group">
                        <label for="metaMensual"><i class="fas fa-bullseye"></i> Meta Mensual ($):</label>
                        <input type="number" id="metaMensual" value="3000" min="0" step="100">
                    </div>
                    
                    <div class="monthly-header">
                        <div class="month-selector">
                            <button id="prevMonth"><i class="fas fa-chevron-left"></i></button>
                            <h3 id="currentMonth">Septiembre 2023</h3>
                            <button id="nextMonth"><i class="fas fa-chevron-right"></i></button>
                        </div>
                        <button id="btnAplicarMeta" class="btn-success">
                            <i class="fas fa-check"></i> Aplicar
                        </button>
                    </div>
                    
                    <div class="calendar-container">
                        <div class="calendar-grid" id="calendarHeaders">
                            <div class="calendar-header">Dom</div>
                            <div class="calendar-header">Lun</div>
                            <div class="calendar-header">Mar</div>
                            <div class="calendar-header">Mié</div>
                            <div class="calendar-header">Jue</div>
                            <div class="calendar-header">Vie</div>
                            <div class="calendar-header">Sáb</div>
                        </div>
                        <div class="calendar-grid" id="calendarDays">
                            <!-- Los días del calendario se generarán con JavaScript -->
                        </div>
                    </div>
                    
                    <div class="monthly-summary">
                        <div class="summary-item">
                            <span>Días laborables:</span>
                            <span id="diasLaborables">22</span>
                        </div>
                        <div class="summary-item">
                            <span>Días de descanso:</span>
                            <span id="diasDescanso">8</span>
                        </div>
                        <div class="summary-item">
                            <span>Meta diaria sugerida:</span>
                            <span id="metaDiariaSugerida">$136.36</span>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="totalGanar"><i class="fas fa-bullseye"></i> Total a Ganar ($):</label>
                    <input type="number" id="totalGanar" value="136.36" min="0" step="50">
                </div>
                
                <div class="form-group">
                    <label for="horasDisponibles"><i class="fas fa-clock"></i> Horas Disponibles:</label>
                    <input type="number" id="horasDisponibles" value="8" min="0" step="0.5">
                </div>

                <div class="form-group">
                    <label for="tiempoPromedioViaje"><i class="fas fa-stopwatch"></i> Tiempo Promedio por Viaje (min):</label>
                    <input type="number" id="tiempoPromedioViaje" value="25" min="5" max="60" step="5">
                </div>

                <button id="btnCalcular">
                    <i class="fas fa-calculator"></i> Calcular Objetivos
                </button>
                
                <div class="calculated-results">
                    <div class="calculated-title"><i class="fas fa-calculator"></i> Resultados Calculados</div>
                    
                    <div class="form-group">
                        <label for="totalViajes"><i class="fas fa-route"></i> Total de Viajes:</label>
                        <input type="text" id="totalViajes" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label for="costoPromedio"><i class="fas fa-money-bill-wave"></i> Costo por Viaje ($):</label>
                        <input type="text" id="costoPromedio" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label for="viajesPorHora"><i class="fas fa-tachometer-alt"></i> Viajes por Hora:</label>
                        <input type="text" id="viajesPorHora" readonly>
                    </div>
                </div>
                
                <h2><i class="fas fa-chart-line"></i> Estadísticas</h2>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Viajes Realizados</div>
                        <div class="stat-value" id="viajesRealizados">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Viajes Necesarios</div>
                        <div class="stat-value" id="viajesNecesarios">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Dinero Acumulado</div>
                        <div class="stat-value" id="dineroAcumulado">$0.00</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Meta Diaria</div>
                        <div class="stat-value" id="metaDisplay">$136.36</div>
                    </div>
                </div>

                <!-- Notificación de finalización automática -->
                <div class="auto-finish-notification" id="autoFinishNotification">
                    <i class="fas fa-robot"></i>
                    <span id="autoFinishMessage"></span>
                </div>
            </div>
            
            <div class="panel">
                <div class="tabs">
                    <div class="tab active" data-tab="hoy">Hoy</div>
                    <div class="tab" data-tab="mes">Resumen Mensual</div>
                </div>
                
                <div class="tab-content active" id="tab-hoy">
                    <h2><i class="fas fa-road"></i> Planificación de Viajes</h2>
                    
                    <div class="progress-container">
                        <div class="progress-header">
                            <span>Progreso hacia Meta Diaria</span>
                            <span id="progressPercentage">0%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progreso" style="width: 0%">
                                <span class="progress-text" id="progressText">0%</span>
                            </div>
                        </div>
                        <div class="progress-details" id="progressDetails">
                            $0.00 de $136.36
                        </div>
                    </div>
                    
                    <div class="saldo-display">
                        <div class="saldo-label"><i class="fas fa-wallet"></i> Saldo Acumulado</div>
                        <div class="saldo-value" id="saldoAcumulado">$0.00</div>
                    </div>

                    <div class="next-trip">
                        <div class="next-trip-title"><i class="fas fa-arrow-right"></i> Próximo Viaje Sugerido</div>
                        <div class="next-trip-amount" id="sugerenciaMonto">$0.00 - $0.00</div>
                        <div style="margin-top: 8px; font-size: 14px; color: var(--gray);">
                            <span id="viajesFaltantes">0</span> viajes restantes hoy
                        </div>
                    </div>
                    
                    <div class="equivalent-notification" id="saldoNotification">
                        <i class="fas fa-coins"></i>
                        <span id="saldoMessage"></span>
                    </div>
                    
                    <h2><i class="fas fa-plus-circle"></i> Registrar Viaje</h2>
                    
                    <div class="form-group">
                        <label for="montoViaje"><i class="fas fa-money-bill"></i> Monto del Viaje ($):</label>
                        <input type="number" id="montoViaje" placeholder="Ingresa el monto del viaje" step="0.01">
                    </div>
                    
                    <button id="btnRegistrar">
                        <i class="fas fa-check"></i> Registrar Viaje
                    </button>
                    
                    <button class="btn-secondary" id="btnFinalizarDia">
                        <i class="fas fa-flag-checkered"></i> Finalizar Día
                    </button>
                    
                    <button class="btn-danger" id="btnReiniciar">
                        <i class="fas fa-trash"></i> Reiniciar Día
                    </button>
                    
                    <h2><i class="fas fa-history"></i> Historial de Viajes</h2>
                    
                    <div class="trip-list" id="listaViajes">
                        <div style="text-align: center; color: var(--gray); padding: 20px;">
                            <i class="fas fa-taxi" style="font-size: 40px; margin-bottom: 10px;"></i>
                            <p>No hay viajes registrados aún</p>
                        </div>
                    </div>
                </div>
                
                <div class="tab-content" id="tab-mes">
                    <h2><i class="fas fa-chart-bar"></i> Resumen Mensual</h2>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-label">Días Trabajados</div>
                            <div class="stat-value" id="diasTrabajados">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Meta Mensual</div>
                            <div class="stat-value" id="metaMensualDisplay">$3,000.00</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Acumulado Mes</div>
                            <div class="stat-value" id="acumuladoMes">$0.00</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Progreso Mensual</div>
                            <div class="stat-value" id="progresoMensual">0%</div>
                        </div>
                    </div>
                    
                    <div class="progress-container">
                        <div class="progress-header">
                            <span>Progreso hacia Meta Mensual</span>
                            <span id="progressMensualPercentage">0%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progresoMensualBar" style="width: 0%">
                                <span class="progress-text" id="progressMensualText">0%</span>
                            </div>
                        </div>
                        <div class="progress-details" id="progressMensualDetails">
                            $0.00 de $3,000.00
                        </div>
                    </div>
                    
                    <h2><i class="fas fa-calendar-check"></i> Días Trabajados</h2>
                    <div class="trip-list" id="listaDiasTrabajados">
                        <div style="text-align: center; color: var(--gray); padding: 20px;">
                            <i class="fas fa-calendar" style="font-size: 40px; margin-bottom: 10px;"></i>
                            <p>No hay días trabajados este mes</p>
                        </div>
                    </div>
                    
                    <button class="btn-warning" id="btnReiniciarMes">
                        <i class="fas fa-sync-alt"></i> Reiniciar Mes Actual
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para resumen del día -->
    <div class="modal" id="modalResumenDia">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-chart-pie"></i> Resumen del Día
                </div>
                <button class="close-modal" id="closeResumenModal">&times;</button>
            </div>
            <div id="resumenDiaContent">
                <!-- El contenido se genera dinámicamente -->
            </div>
            <button class="btn-success" id="btnConfirmarFinalizar" style="margin-top: 20px;">
                <i class="fas fa-check-circle"></i> Confirmar Finalización
            </button>
        </div>
    </div>

    <script>
        // Clase principal optimizada para la calculadora Uber
        class UberCalculator {
            constructor() {
                this.metaDiaria = 136.36;
                this.metaMensual = 3000;
                this.costoPromedio = 40;
                this.tiempoPromedioViaje = 25;
                this.viajes = [];
                this.totalAcumulado = 0;
                this.saldoAcumulado = 0;
                this.diasDescanso = [];
                this.diasTrabajados = {};
                this.currentDate = new Date();
                this.currentMonth = this.currentDate.getMonth();
                this.currentYear = this.currentDate.getFullYear();
                this.currentDayKey = this.getDayKey(this.currentDate);
                
                // Optimizaciones de rendimiento
                this.debounceTimers = {};
                this.calculationCache = new Map();
                this.performanceMarks = new Map();
                
                // Nombres de meses
                this.monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio",
                                 "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
                
                this.init();
            }

            // Inicialización optimizada
            init() {
                this.startPerformanceMark('init');
                this.cacheDOM();
                this.bindEvents();
                this.loadSavedValues();
                this.updateUI();
                this.setupPerformanceMonitoring();
                this.endPerformanceMark('init');
                
                // Configurar verificación periódica
                setInterval(() => this.verificarFinalizacionAutomatica(), 60000);
            }

            // Cache de elementos DOM para mejor performance
            cacheDOM() {
                this.dom = {
                    totalGanarInput: document.getElementById('totalGanar'),
                    horasDisponiblesInput: document.getElementById('horasDisponibles'),
                    tiempoPromedioViajeInput: document.getElementById('tiempoPromedioViaje'),
                    totalViajesInput: document.getElementById('totalViajes'),
                    costoPromedioInput: document.getElementById('costoPromedio'),
                    viajesPorHoraInput: document.getElementById('viajesPorHora'),
                    montoViajeInput: document.getElementById('montoViaje'),
                    viajesRealizadosElement: document.getElementById('viajesRealizados'),
                    viajesNecesariosElement: document.getElementById('viajesNecesarios'),
                    dineroAcumuladoElement: document.getElementById('dineroAcumulado'),
                    metaDisplayElement: document.getElementById('metaDisplay'),
                    progresoElement: document.getElementById('progreso'),
                    progressTextElement: document.getElementById('progressText'),
                    progressPercentageElement: document.getElementById('progressPercentage'),
                    progressDetailsElement: document.getElementById('progressDetails'),
                    sugerenciaMontoElement: document.getElementById('sugerenciaMonto'),
                    viajesFaltantesElement: document.getElementById('viajesFaltantes'),
                    listaViajesElement: document.getElementById('listaViajes'),
                    saldoAcumuladoElement: document.getElementById('saldoAcumulado'),
                    saldoNotification: document.getElementById('saldoNotification'),
                    saldoMessage: document.getElementById('saldoMessage'),
                    metaMensualInput: document.getElementById('metaMensual'),
                    currentMonthElement: document.getElementById('currentMonth'),
                    calendarDaysElement: document.getElementById('calendarDays'),
                    diasLaborablesElement: document.getElementById('diasLaborables'),
                    diasDescansoElement: document.getElementById('diasDescanso'),
                    metaDiariaSugeridaElement: document.getElementById('metaDiariaSugerida'),
                    btnAplicarMeta: document.getElementById('btnAplicarMeta'),
                    prevMonthButton: document.getElementById('prevMonth'),
                    nextMonthButton: document.getElementById('nextMonth'),
                    diasTrabajadosElement: document.getElementById('diasTrabajados'),
                    metaMensualDisplayElement: document.getElementById('metaMensualDisplay'),
                    acumuladoMesElement: document.getElementById('acumuladoMes'),
                    progresoMensualElement: document.getElementById('progresoMensual'),
                    progresoMensualBarElement: document.getElementById('progresoMensualBar'),
                    progressMensualTextElement: document.getElementById('progressMensualText'),
                    progressMensualPercentageElement: document.getElementById('progressMensualPercentage'),
                    progressMensualDetailsElement: document.getElementById('progressMensualDetails'),
                    listaDiasTrabajadosElement: document.getElementById('listaDiasTrabajados'),
                    btnReiniciarMes: document.getElementById('btnReiniciarMes'),
                    btnFinalizarDia: document.getElementById('btnFinalizarDia'),
                    modalResumenDia: document.getElementById('modalResumenDia'),
                    closeResumenModal: document.getElementById('closeResumenModal'),
                    resumenDiaContent: document.getElementById('resumenDiaContent'),
                    btnConfirmarFinalizar: document.getElementById('btnConfirmarFinalizar'),
                    autoFinishNotification: document.getElementById('autoFinishNotification'),
                    autoFinishMessage: document.getElementById('autoFinishMessage'),
                    btnCalcular: document.getElementById('btnCalcular'),
                    btnRegistrar: document.getElementById('btnRegistrar'),
                    btnReiniciar: document.getElementById('btnReiniciar')
                };
            }

            // Configuración de eventos optimizada
            bindEvents() {
                // Debouncing para inputs que disparan cálculos
                this.setupDebouncedEvent(this.dom.totalGanarInput, 'change', () => this.calcularObjetivos(), 300);
                this.setupDebouncedEvent(this.dom.horasDisponiblesInput, 'change', () => this.calcularObjetivos(), 300);
                this.setupDebouncedEvent(this.dom.tiempoPromedioViajeInput, 'change', () => this.calcularObjetivos(), 300);
                
                // Eventos directos
                this.dom.btnCalcular.addEventListener('click', () => this.calcularObjetivos());
                this.dom.btnRegistrar.addEventListener('click', () => this.registrarViaje());
                this.dom.btnReiniciar.addEventListener('click', () => this.reiniciarDia());
                this.dom.btnFinalizarDia.addEventListener('click', () => this.mostrarResumenDia());
                this.dom.btnAplicarMeta.addEventListener('click', () => this.aplicarMetaMensual());
                this.dom.prevMonthButton.addEventListener('click', () => this.cambiarMes(-1));
                this.dom.nextMonthButton.addEventListener('click', () => this.cambiarMes(1));
                this.dom.btnReiniciarMes.addEventListener('click', () => this.reiniciarMes());
                this.dom.closeResumenModal.addEventListener('click', () => this.dom.modalResumenDia.style.display = 'none');
                this.dom.btnConfirmarFinalizar.addEventListener('click', () => this.finalizarDia());
                
                // Cerrar modal al hacer clic fuera
                window.addEventListener('click', (e) => {
                    if (e.target === this.dom.modalResumenDia) {
                        this.dom.modalResumenDia.style.display = 'none';
                    }
                });
                
                // Configurar pestañas con event delegation
                document.querySelector('.tabs').addEventListener('click', (e) => {
                    if (e.target.classList.contains('tab')) {
                        this.handleTabChange(e.target.dataset.tab);
                    }
                });

                // Event delegation para calendario
                this.dom.calendarDaysElement.addEventListener('click', (e) => {
                    if (e.target.classList.contains('calendar-day') && !e.target.classList.contains('other-month')) {
                        this.handleCalendarClick(e.target);
                    }
                });
            }

            // Debouncing optimizado
            setupDebouncedEvent(element, event, callback, delay) {
                let timer;
                element.addEventListener(event, () => {
                    clearTimeout(timer);
                    timer = setTimeout(callback, delay);
                });
            }

            // Manejo de pestañas optimizado - CORREGIDO: classlist -> classList
            handleTabChange(tabId) {
                // Desactivar todas las pestañas
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                // Activar la pestaña seleccionada
                document.querySelector(`.tab[data-tab="${tabId}"]`).classList.add('active');
                document.getElementById(`tab-${tabId}`).classList.add('active');
                
                // Si es la pestaña de mes, actualizar el resumen
                if (tabId === 'mes') {
                    this.actualizarResumenMensualCompleto();
                }
            }

            // Manejo de clics en calendario optimizado
            handleCalendarClick(dayElement) {
                const dayNumber = parseInt(dayElement.textContent);
                if (isNaN(dayNumber)) return;
                
                const dateStr = `${this.currentYear}-${this.currentMonth + 1}-${dayNumber}`;
                this.toggleDiaDescanso(dateStr, dayElement);
            }

            // Función para actualizar toda la UI de forma optimizada
            updateUI() {
                this.startPerformanceMark('updateUI');
                this.calcularObjetivos();
                this.actualizarProgreso();
                this.actualizarSugerencia();
                this.actualizarListaViajes();
                this.actualizarEstadisticas();
                this.dom.saldoAcumuladoElement.textContent = `$${this.saldoAcumulado.toFixed(2)}`;
                this.actualizarResumenMensualCompleto();
                this.generarCalendario();
                this.endPerformanceMark('updateUI');
            }

            // Nueva función: Verificar finalización automática
            verificarFinalizacionAutomatica() {
                const ahora = new Date();
                const horaActual = ahora.getHours();
                const minutosActual = ahora.getMinutes();
                const diaActual = ahora.getDate();
                const mesActual = ahora.getMonth();
                const añoActual = ahora.getFullYear();
                const diaKeyActual = `${diaActual}-${mesActual}-${añoActual}`;
                
                // Verificar si es después de las 10 PM (22:00) y hay viajes registrados hoy
                // y el día actual no ha sido guardado en diasTrabajados
                if ((horaActual > 22 || (horaActual === 22 && minutosActual >= 0)) && 
                    this.viajes.length > 0 && 
                    !this.diasTrabajados[diaKeyActual]) {
                    
                    // Mostrar notificación
                    this.dom.autoFinishMessage.textContent = "Finalizando día automáticamente...";
                    this.dom.autoFinishNotification.style.display = 'block';
                    
                    // Esperar 3 segundos para que el usuario vea la notificación
                    setTimeout(() => {
                        this.finalizarDiaAutomaticamente();
                    }, 3000);
                }
            }
            
            // Nueva función: Finalizar día automáticamente
            finalizarDiaAutomaticamente() {
                const hoy = new Date();
                const dayKey = `${hoy.getDate()}-${hoy.getMonth()}-${hoy.getFullYear()}`;
                
                // Guardar el total del día en el historial de días trabajados
                this.diasTrabajados[dayKey] = (this.diasTrabajados[dayKey] || 0) + this.totalAcumulado;
                
                // Reiniciar contadores del día
                this.viajes = [];
                this.totalAcumulado = 0;
                this.saldoAcumulado = 0;
                
                // Ocultar notificaciones
                this.dom.saldoNotification.style.display = 'none';
                
                // Actualizar la UI
                this.actualizarProgreso();
                this.actualizarSugerencia();
                this.actualizarListaViajes();
                this.actualizarEstadisticas();
                this.dom.saldoAcumuladoElement.textContent = `$${this.saldoAcumulado.toFixed(2)}`;
                
                // Actualizar resumen mensual
                this.actualizarResumenMensualCompleto();
                
                // Regenerar el calendario para actualizar los días marcados
                this.generarCalendario();
                
                // Guardar valores
                this.guardarValores();
                
                // Actualizar notificación
                this.dom.autoFinishMessage.textContent = "Día finalizado automáticamente.";
                
                // Ocultar notificación después de 5 segundos
                setTimeout(() => {
                    this.dom.autoFinishNotification.style.display = 'none';
                }, 5000);
            }
            
            // Función para verificar si un día es pasado
            esDiaPasado(year, month, day) {
                const today = new Date();
                const fecha = new Date(year, month, day);
                const todayStart = new Date(today.getFullYear(), today.getMonth(), today.getDate());
                return fecha < todayStart;
            }
            
            // Generar calendario optimizado con DocumentFragment
            generarCalendario() {
                this.startPerformanceMark('generarCalendario');
                
                // Actualizar el encabezado del mes
                this.dom.currentMonthElement.textContent = `${this.monthNames[this.currentMonth]} ${this.currentYear}`;
                
                // Obtener el primer día del mes y la cantidad de días
                const firstDay = new Date(this.currentYear, this.currentMonth, 1);
                const lastDay = new Date(this.currentYear, this.currentMonth + 1, 0);
                const daysInMonth = lastDay.getDate();
                
                // Obtener el día de la semana del primer día (0 = Domingo, 1 = Lunes, etc.)
                const startingDay = firstDay.getDay();
                
                // Usar DocumentFragment para minimizar reflows
                const fragment = document.createDocumentFragment();
                
                // Agregar días vacíos para alinear el primer día
                for (let i = 0; i < startingDay; i++) {
                    const emptyDay = document.createElement('div');
                    emptyDay.className = 'calendar-day other-month';
                    fragment.appendChild(emptyDay);
                }
                
                // Agregar los días del mes
                const today = new Date();
                for (let i = 1; i <= daysInMonth; i++) {
                    const day = document.createElement('div');
                    day.className = 'calendar-day workday';
                    day.textContent = i;
                    
                    // Comprobar si es día pasado
                    if (this.esDiaPasado(this.currentYear, this.currentMonth, i)) {
                        day.classList.add('past-day');
                    }
                    
                    // Comprobar si es hoy
                    if (this.currentYear === today.getFullYear() && this.currentMonth === today.getMonth() && i === today.getDate()) {
                        day.classList.add('today');
                    }
                    
                    // Comprobar si es día de descanso
                    const dateStr = `${this.currentYear}-${this.currentMonth + 1}-${i}`;
                    if (this.diasDescanso.includes(dateStr)) {
                        day.classList.add('restday');
                    }
                    
                    // Comprobar si es día trabajado
                    const dayKey = `${i}-${this.currentMonth}-${this.currentYear}`;
                    if (this.diasTrabajados[dayKey]) {
                        // Verificar si se alcanzó la meta ese día
                        const metaDiariaEsperada = this.metaMensual / (daysInMonth - this.diasDescanso.length);
                        if (this.diasTrabajados[dayKey] >= metaDiariaEsperada * 0.95) {
                            day.classList.add('meta-alcanzada');
                            day.innerHTML = `${i} <span class="day-status">✓</span>`;
                        } else {
                            day.classList.add('meta-no-alcanzada');
                            day.innerHTML = `${i} <span class="day-status">✗</span>`;
                        }
                        day.title = `Ganado: $${this.diasTrabajados[dayKey].toFixed(2)}`;
                    }
                    
                    fragment.appendChild(day);
                }
                
                // Actualizar de una sola vez
                this.dom.calendarDaysElement.innerHTML = '';
                this.dom.calendarDaysElement.appendChild(fragment);
                
                // Actualizar resumen mensual después de generar el calendario
                this.actualizarResumenMensual();
                this.endPerformanceMark('generarCalendario');
            }
            
            // Cambiar entre meses
            cambiarMes(direction) {
                // Guardar configuración del mes actual antes de cambiar
                this.guardarValores();
                
                this.currentMonth += direction;
                
                // Ajustar año si es necesario
                if (this.currentMonth < 0) {
                    this.currentMonth = 11;
                    this.currentYear--;
                } else if (this.currentMonth > 11) {
                    this.currentMonth = 0;
                    this.currentYear++;
                }
                
                // Cargar configuración del nuevo mes
                this.cargarValoresGuardados();
                
                // Regenerar el calendario
                this.generarCalendario();
            }
            
            // Alternar día de descanso
            toggleDiaDescanso(dateStr, dayElement) {
                const index = this.diasDescanso.indexOf(dateStr);
                
                if (index === -1) {
                    // Agregar como día de descanso
                    this.diasDescanso.push(dateStr);
                    dayElement.classList.add('restday');
                } else {
                    // Quitar como día de descanso
                    this.diasDescanso.splice(index, 1);
                    dayElement.classList.remove('restday');
                }
                
                this.actualizarResumenMensual();
                this.guardarValores();
            }
            
            // Actualizar resumen mensual
            actualizarResumenMensual() {
                // Obtener la cantidad de días en el mes
                const lastDay = new Date(this.currentYear, this.currentMonth + 1, 0);
                const daysInMonth = lastDay.getDate();
                
                // Calcular días laborables (todos los días menos los de descanso)
                const diasLaborables = daysInMonth - this.diasDescanso.length;
                
                // Calcular meta diaria sugerida
                const metaDiariaSugerida = this.metaMensual / diasLaborables;
                
                // Actualizar la UI
                this.dom.diasLaborablesElement.textContent = diasLaborables;
                this.dom.diasDescansoElement.textContent = this.diasDescanso.length;
                this.dom.metaDiariaSugeridaElement.textContent = `$${metaDiariaSugerida.toFixed(2)}`;
            }
            
            // Actualizar resumen mensual completo
            actualizarResumenMensualCompleto() {
                // Calcular el acumulado del mes
                let acumuladoMes = 0;
                let diasConTrabajo = 0;
                
                for (const dayKey in this.diasTrabajados) {
                    if (dayKey.endsWith(`-${this.currentMonth}-${this.currentYear}`)) {
                        acumuladoMes += this.diasTrabajados[dayKey];
                        diasConTrabajo++;
                    }
                }
                
                // Calcular el progreso mensual
                const progresoMensual = Math.min(100, (acumuladoMes / this.metaMensual) * 100);
                
                // Actualizar la UI
                this.dom.diasTrabajadosElement.textContent = diasConTrabajo;
                this.dom.metaMensualDisplayElement.textContent = `$${this.metaMensual.toFixed(2)}`;
                this.dom.acumuladoMesElement.textContent = `$${acumuladoMes.toFixed(2)}`;
                this.dom.progresoMensualElement.textContent = `${progresoMensual.toFixed(1)}%`;
                
                // Actualizar barra de progreso mensual
                this.dom.progresoMensualBarElement.style.width = `${progresoMensual}%`;
                this.dom.progressMensualTextElement.textContent = `${progresoMensual.toFixed(1)}%`;
                this.dom.progressMensualPercentageElement.textContent = `${progresoMensual.toFixed(1)}%`;
                this.dom.progressMensualDetailsElement.textContent = `$${acumuladoMes.toFixed(2)} de $${this.metaMensual.toFixed(2)}`;
                
                // Cambiar color según el progreso
                if (progresoMensual >= 100) {
                    this.dom.progresoMensualBarElement.style.background = 'linear-gradient(90deg, var(--success), #16a34a)';
                } else if (progresoMensual >= 70) {
                    this.dom.progresoMensualBarElement.style.background = 'linear-gradient(90deg, var(--warning), #ea580c)';
                } else {
                    this.dom.progresoMensualBarElement.style.background = 'linear-gradient(90deg, var(--primary), var(--secondary))';
                }
                
                // Actualizar lista de días trabajados
                this.actualizarListaDiasTrabajados();
            }
            
            // Actualizar lista de días trabajados optimizada
            actualizarListaDiasTrabajados() {
                this.dom.listaDiasTrabajadosElement.innerHTML = '';
                
                const diasDelMes = [];
                for (const dayKey in this.diasTrabajados) {
                    if (dayKey.endsWith(`-${this.currentMonth}-${this.currentYear}`)) {
                        diasDelMes.push({
                            key: dayKey,
                            monto: this.diasTrabajados[dayKey]
                        });
                    }
                }
                
                if (diasDelMes.length === 0) {
                    this.dom.listaDiasTrabajadosElement.innerHTML = `
                        <div style="text-align: center; color: var(--gray); padding: 20px;">
                            <i class="fas fa-calendar" style="font-size: 40px; margin-bottom: 10px;"></i>
                            <p>No hay días trabajados este mes</p>
                        </div>
                    `;
                    return;
                }
                
                // Ordenar días por fecha (más recientes primero)
                diasDelMes.sort((a, b) => {
                    const [dayA, monthA, yearA] = a.key.split('-').map(Number);
                    const [dayB, monthB, yearB] = b.key.split('-').map(Number);
                    const dateA = new Date(yearA, monthA, dayA);
                    const dateB = new Date(yearB, monthB, dayB);
                    return dateB - dateA;
                });
                
                // Usar DocumentFragment para mejor performance
                const fragment = document.createDocumentFragment();
                
                diasDelMes.forEach(dia => {
                    const [day, month, year] = dia.key.split('-').map(Number);
                    const fecha = new Date(year, month, day);
                    const diaElement = document.createElement('div');
                    diaElement.className = 'trip-item';
                    
                    // Verificar si se alcanzó la meta
                    const metaDiariaEsperada = this.metaMensual / (new Date(year, month + 1, 0).getDate() - this.diasDescanso.length);
                    const alcanzada = dia.monto >= metaDiariaEsperada * 0.95;
                    
                    diaElement.innerHTML = `
                        <div class="trip-info">
                            <span class="trip-number">${day} de ${this.monthNames[month]} ${year}</span>
                            <span class="trip-time">${fecha.toLocaleDateString('es-ES', { weekday: 'long' })}</span>
                        </div>
                        <span class="trip-amount" style="color: ${alcanzada ? 'var(--success)' : 'var(--danger)'}">
                            $${dia.monto.toFixed(2)} ${alcanzada ? '✓' : '✗'}
                        </span>
                    `;
                    fragment.appendChild(diaElement);
                });
                
                this.dom.listaDiasTrabajadosElement.appendChild(fragment);
            }
            
            // Aplicar meta mensual
            aplicarMetaMensual() {
                this.metaMensual = parseFloat(this.dom.metaMensualInput.value) || 3000;
                this.actualizarResumenMensual();
                
                // Obtener la meta diaria sugerida
                const metaDiariaSugerida = parseFloat(this.dom.metaDiariaSugeridaElement.textContent.replace('$', '').replace(',', ''));
                
                // Actualizar la meta diaria
                this.metaDiaria = metaDiariaSugerida;
                this.dom.totalGanarInput.value = metaDiariaSugerida.toFixed(2);
                
                // Recalcular objetivos
                this.calcularObjetivos();
                
                // Actualizar resumen mensual completo
                this.actualizarResumenMensualCompleto();
                
                // Guardar valores
                this.guardarValores();
            }
            
            // Calcular objetivos optimizado con memoización
            calcularObjetivos() {
                this.startPerformanceMark('calcularObjetivos');
                
                // Generar clave de caché
                const metaDiaria = parseFloat(this.dom.totalGanarInput.value) || 136.36;
                const horasDisponibles = parseFloat(this.dom.horasDisponiblesInput.value) || 8;
                const tiempoPromedioViaje = parseFloat(this.dom.tiempoPromedioViajeInput.value) || 25;
                
                const cacheKey = `calc-${metaDiaria}-${horasDisponibles}-${tiempoPromedioViaje}`;
                
                // Verificar si tenemos el resultado en caché
                if (this.calculationCache.has(cacheKey)) {
                    const result = this.calculationCache.get(cacheKey);
                    this.updateCalculatedFields(result);
                    this.endPerformanceMark('calcularObjetivos');
                    return;
                }
                
                this.metaDiaria = metaDiaria;
                this.tiempoPromedioViaje = tiempoPromedioViaje;
                
                // Calcular viajes por hora
                const viajesPorHora = 60 / this.tiempoPromedioViaje;
                
                // Calcular viajes necesarios basados en tiempo disponible
                const viajesNecesarios = Math.ceil(horasDisponibles * viajesPorHora);
                
                // Calcular costo promedio por viaje
                this.costoPromedio = this.metaDiaria / viajesNecesarios;
                
                const result = {
                    viajesNecesarios,
                    viajesPorHora: viajesPorHora.toFixed(1),
                    costoPromedio: this.costoPromedio
                };
                
                // Guardar en caché
                this.calculationCache.set(cacheKey, result);
                
                // Actualizar UI
                this.updateCalculatedFields(result);
                this.actualizarSugerencia();
                this.actualizarEstadisticas();
                this.actualizarProgreso();
                
                // Guardar valores
                this.guardarValores();
                this.endPerformanceMark('calcularObjetivos');
            }
            
            // Actualizar campos calculados
            updateCalculatedFields(result) {
                this.dom.totalViajesInput.value = result.viajesNecesarios;
                this.dom.costoPromedioInput.value = `$${result.costoPromedio.toFixed(2)}`;
                this.dom.viajesPorHoraInput.value = result.viajesPorHora;
                
                // Actualizar la UI
                this.dom.viajesNecesariosElement.textContent = result.viajesNecesarios;
                this.dom.metaDisplayElement.textContent = `$${this.metaDiaria.toFixed(2)}`;
            }
            
            // Registrar un nuevo viaje optimizado
            registrarViaje() {
                this.startPerformanceMark('registrarViaje');
                const monto = parseFloat(this.dom.montoViajeInput.value);
                
                if (!this.isValidMonto(monto)) {
                    this.mostrarNotificacion('Por favor ingresa un monto válido para el viaje.', 'error');
                    this.endPerformanceMark('registrarViaje');
                    return;
                }
                
                // Procesar el viaje
                const viajeData = this.processViaje(monto);
                this.addViaje(viajeData);
                this.processSaldo(viajeData);
                this.autoUseSaldo();
                
                this.updateUI();
                this.saveValues();
                
                // Limpiar input y focus para siguiente entrada
                this.dom.montoViajeInput.value = '';
                this.dom.montoViajeInput.focus();
                this.endPerformanceMark('registrarViaje');
            }
            
            // Validar monto
            isValidMonto(monto) {
                return !isNaN(monto) && monto > 0 && monto < 10000; // Límite razonable
            }
            
            // Procesar datos del viaje
            processViaje(monto) {
                const ahora = new Date();
                const sugerencia = this.getSugerenciaActual();
                
                let multiplicador = 1;
                let resto = 0;
                let tipo = 'normal';

                if (sugerencia.minSugerido > 0 && monto < sugerencia.minSugerido) {
                    tipo = 'saldo';
                } else if (sugerencia.maxSugerido > 0 && monto > sugerencia.maxSugerido) {
                    multiplicador = Math.floor(monto / this.costoPromedio);
                    resto = monto % this.costoPromedio;
                } else {
                    resto = Math.max(0, monto - this.costoPromedio);
                }

                return {
                    monto,
                    hora: ahora.toLocaleTimeString(),
                    timestamp: ahora.getTime(),
                    multiplicador,
                    resto,
                    tipo
                };
            }
            
            // Obtener sugerencia actual
            getSugerenciaActual() {
                const sugerenciaText = this.dom.sugerenciaMontoElement.textContent;
                const sugerenciaMatch = sugerenciaText.match(/\$([0-9.]+) - \$([0-9.]+)/);
                
                let minSugerido = 0;
                let maxSugerido = 0;
                
                if (sugerenciaMatch && sugerenciaMatch.length >= 3) {
                    minSugerido = parseFloat(sugerenciaMatch[1]);
                    maxSugerido = parseFloat(sugerenciaMatch[2]);
                }
                
                return { minSugerido, maxSugerido };
            }
            
            // Agregar viaje a la lista
            addViaje(viajeData) {
                this.viajes.push(viajeData);
                this.totalAcumulado += viajeData.monto;
            }
            
            // Procesar saldo generado
            processSaldo(viajeData) {
                if (viajeData.resto > 0) {
                    this.saldoAcumulado += viajeData.resto;
                    this.dom.saldoAcumuladoElement.textContent = `$${this.saldoAcumulado.toFixed(2)}`;
                    
                    // Mostrar notificación de saldo generado
                    this.dom.saldoMessage.textContent = `¡Has generado $${viajeData.resto.toFixed(2)} de saldo! Saldo total: $${this.saldoAcumulado.toFixed(2)}`;
                    this.dom.saldoNotification.style.display = 'block';
                    
                    // Ocultar la notificación después de 5 segundos
                    setTimeout(() => {
                        this.dom.saldoNotification.style.display = 'none';
                    }, 5000);
                }
            }
            
            // Usar saldo automáticamente
            autoUseSaldo() {
                // Verificar si hay suficiente saldo para al menos un viaje
                while (this.saldoAcumulado >= this.costoPromedio) {
                    // Usar el saldo para un viaje
                    this.saldoAcumulado -= this.costoPromedio;
                    this.dom.saldoAcumuladoElement.textContent = `$${this.saldoAcumulado.toFixed(2)}`;
                    
                    // Registrar un viaje con saldo (pero NO sumar al totalAcumulado)
                    const ahora = new Date();
                    this.viajes.push({
                        monto: 0,
                        hora: ahora.toLocaleTimeString(),
                        timestamp: ahora.getTime(),
                        multiplicador: 1,
                        tipo: 'saldo'
                    });
                    
                    // Mostrar notificación
                    this.dom.saldoMessage.textContent = `¡Viaje generado automáticamente con saldo! Saldo restante: $${this.saldoAcumulado.toFixed(2)}`;
                    this.dom.saldoNotification.style.display = 'block';
                    
                    // Ocultar la notificación después de 5 segundos
                    setTimeout(() => {
                        this.dom.saldoNotification.style.display = 'none';
                    }, 5000);
                    
                    // Actualizar la UI
                    this.actualizarProgreso();
                    this.actualizarSugerencia();
                    this.actualizarListaViajes();
                    this.actualizarEstadisticas();
                }
            }
            
            // Mostrar resumen del día antes de finalizar
            mostrarResumenDia() {
                // Calcular estadísticas del día
                const viajesRealizados = this.viajes.reduce((total, viaje) => total + (viaje.multiplicador || 0), 0);
                const totalGanado = this.totalAcumulado;
                const metaAlcanzada = totalGanado >= this.metaDiaria * 0.95;
                const diferencia = totalGanado - this.metaDiaria;
                
                // Generar contenido del resumen
                let contenidoHTML = `
                    <div class="resumen-destacado">
                        <div class="resumen-item">
                            <span class="resumen-label">Meta del día:</span>
                            <span class="resumen-value">$${this.metaDiaria.toFixed(2)}</span>
                        </div>
                        <div class="resumen-item">
                            <span class="resumen-label">Total ganado:</span>
                            <span class="resumen-value">$${totalGanado.toFixed(2)}</span>
                        </div>
                        <div class="resumen-item">
                            <span class="resumen-label">Estado:</span>
                            <span class="resumen-value" style="color: ${metaAlcanzada ? 'var(--success)' : 'var(--danger)'}">
                                ${metaAlcanzada ? 'Meta Alcanzada ✓' : 'Meta No Alcanzada ✗'}
                            </span>
                        </div>
                    </div>
                    
                    <div class="resumen-item">
                        <span class="resumen-label">Diferencia:</span>
                        <span class="resumen-value" style="color: ${diferencia >= 0 ? 'var(--success)' : 'var(--danger)'}">
                            $${diferencia.toFixed(2)}
                        </span>
                    </div>
                    
                    <div class="resumen-item">
                        <span class="resumen-label">Viajes realizados:</span>
                        <span class="resumen-value">${viajesRealizados}</span>
                    </div>
                    
                    <div class="resumen-item">
                        <span class="resumen-label">Saldo acumulado:</span>
                        <span class="resumen-value">$${this.saldoAcumulado.toFixed(2)}</span>
                    </div>
                `;
                
                // Mostrar historial de viajes
                contenidoHTML += `
                    <h3 style="margin-top: 20px; color: var(--primary);">Historial de Viajes</h3>
                    <div style="max-height: 200px; overflow-y: auto;">
                `;
                
                if (this.viajes.length === 0) {
                    contenidoHTML += `
                        <div style="text-align: center; color: var(--gray); padding: 10px;">
                            <p>No hay viajes registrados hoy</p>
                        </div>
                    `;
                } else {
                    // Ordenar viajes por timestamp (más recientes primero)
                    this.viajes.sort((a, b) => b.timestamp - a.timestamp);
                    
                    this.viajes.forEach((viaje, index) => {
                        const multiplicadorBadge = viaje.multiplicador > 1 ? 
                            `<span style="font-size: 10px; background: var(--warning); color: white; padding: 2px 5px; border-radius: 10px; margin-left: 5px;">x${viaje.multiplicador}</span>` : '';
                        
                        if (viaje.tipo === 'saldo') {
                            contenidoHTML += `
                                <div class="resumen-item">
                                    <span class="resumen-label">Viaje #${this.viajes.length - index} ${multiplicadorBadge}</span>
                                    <span class="resumen-value" style="color: var(--warning)">Viaje con saldo</span>
                                </div>
                            `;
                        } else {
                            contenidoHTML += `
                                <div class="resumen-item">
                                    <span class="resumen-label">Viaje #${this.viajes.length - index} ${multiplicadorBadge}</span>
                                    <span class="resumen-value">$${viaje.monto.toFixed(2)}</span>
                                </div>
                            `;
                        }
                    });
                }
                
                contenidoHTML += `</div>`;
                
                // Actualizar contenido del modal
                this.dom.resumenDiaContent.innerHTML = contenidoHTML;
                
                // Mostrar modal
                this.dom.modalResumenDia.style.display = 'flex';
            }
            
            // Finalizar el día (guardar progreso pero mantener datos)
            finalizarDia() {
                // Ocultar modal
                this.dom.modalResumenDia.style.display = 'none';
                
                // Guardar el total del día en el historial de días trabajados
                const hoy = new Date();
                const dayKey = `${hoy.getDate()}-${hoy.getMonth()}-${hoy.getFullYear()}`;
                
                // Sumar el acumulado actual al día (por si ya existía)
                this.diasTrabajados[dayKey] = (this.diasTrabajados[dayKey] || 0) + this.totalAcumulado;
                
                // Reiniciar contadores del día
                this.viajes = [];
                this.totalAcumulado = 0;
                this.saldoAcumulado = 0;
                
                // Ocultar notificaciones
                this.dom.saldoNotification.style.display = 'none';
                
                // Actualizar la UI
                this.actualizarProgreso();
                this.actualizarSugerencia();
                this.actualizarListaViajes();
                this.actualizarEstadisticas();
                this.dom.saldoAcumuladoElement.textContent = `$${this.saldoAcumulado.toFixed(2)}`;
                
                // Actualizar resumen mensual
                this.actualizarResumenMensualCompleto();
                
                // Regenerar el calendario para actualizar los días marcados
                this.generarCalendario();
                
                // Guardar valores
                this.guardarValores();
                
                this.mostrarNotificacion('Día finalizado correctamente. Los datos se han guardado en el historial mensual.', 'success');
            }
            
            // Reiniciar el día
            reiniciarDia() {
                if (confirm('¿Estás seguro de que quieres reiniciar el día? Se borrarán todos los viajes registrados y el saldo acumulado.')) {
                    // Guardar el total del día en el historial de días trabajados
                    if (this.totalAcumulado > 0) {
                        const today = new Date();
                        const dayKey = `${today.getDate()}-${today.getMonth()}-${today.getFullYear()}`;
                        this.diasTrabajados[dayKey] = this.totalAcumulado;
                    }
                    
                    this.viajes = [];
                    this.totalAcumulado = 0;
                    this.saldoAcumulado = 0;
                    
                    // Ocultar notificaciones
                    this.dom.saldoNotification.style.display = 'none';
                    
                    // Actualizar la UI
                    this.actualizarProgreso();
                    this.actualizarSugerencia();
                    this.actualizarListaViajes();
                    this.actualizarEstadisticas();
                    this.dom.saldoAcumuladoElement.textContent = `$${this.saldoAcumulado.toFixed(2)}`;
                    
                    // Actualizar resumen mensual
                    this.actualizarResumenMensualCompleto();
                    
                    // Guardar valores
                    this.guardarValores();
                }
            }
            
            // Reiniciar el mes
            reiniciarMes() {
                if (confirm('¿Estás seguro de que quieres reiniciar el mes actual? Se borrarán todos los datos de este mes, incluyendo días trabajados.')) {
                    // Eliminar todos los días trabajados del mes actual
                    for (const dayKey in this.diasTrabajados) {
                        if (dayKey.endsWith(`-${this.currentMonth}-${this.currentYear}`)) {
                            delete this.diasTrabajados[dayKey];
                        }
                    }
                    
                    // Si estamos en el día actual, reiniciar también el día
                    const today = new Date();
                    if (this.currentMonth === today.getMonth() && this.currentYear === today.getFullYear()) {
                        this.viajes = [];
                        this.totalAcumulado = 0;
                        this.saldoAcumulado = 0;
                        
                        // Actualizar la UI del día
                        this.actualizarProgreso();
                        this.actualizarSugerencia();
                        this.actualizarListaViajes();
                        this.actualizarEstadisticas();
                        this.dom.saldoAcumuladoElement.textContent = `$${this.saldoAcumulado.toFixed(2)}`;
                    }
                    
                    // Actualizar resumen mensual
                    this.actualizarResumenMensualCompleto();
                    
                    // Regenerar el calendario para actualizar los días marcados
                    this.generarCalendario();
                    
                    // Guardar valores
                    this.guardarValores();
                }
            }
            
            // Actualizar la barra de progreso
            actualizarProgreso() {
                // Calcular el progreso en dinero (0-100%)
                const progresoDinero = Math.min(100, (this.totalAcumulado / this.metaDiaria) * 100);
                
                // Actualizar elementos de UI
                this.dom.progresoElement.style.width = `${progresoDinero}%`;
                this.dom.progressTextElement.textContent = `${progresoDinero.toFixed(1)}%`;
                this.dom.progressPercentageElement.textContent = `${progresoDinero.toFixed(1)}%`;
                
                // Detalles del progreso
                this.dom.progressDetailsElement.textContent = `$${this.totalAcumulado.toFixed(2)} de $${this.metaDiaria.toFixed(2)}`;
                
                // Cambiar color según el progreso
                if (progresoDinero >= 100) {
                    this.dom.progresoElement.style.background = 'linear-gradient(90deg, var(--success), #16a34a)';
                } else if (progresoDinero >= 70) {
                    this.dom.progresoElement.style.background = 'linear-gradient(90deg, var(--warning), #ea580c)';
                } else {
                    this.dom.progresoElement.style.background = 'linear-gradient(90deg, var(--primary), var(--secondary))';
                }
            }
            
            // Actualizar la sugerencia para el próximo viaje
            actualizarSugerencia() {
                // Calcular el total de viajes equivalentes realizados
                const viajesRealizados = this.viajes.reduce((total, viaje) => total + (viaje.multiplicador || 0), 0);
                
                const viajesNecesarios = parseInt(this.dom.totalViajesInput.value) || 0;
                const viajesRestantes = Math.max(0, viajesNecesarios - viajesRealizados);
                
                // Calcular el dinero restante para alcanzar la meta
                const dineroRestante = Math.max(0, this.metaDiaria - this.totalAcumulado);
                
                if (viajesRestantes <= 0 || dineroRestante <= 0) {
                    this.dom.sugerenciaMontoElement.textContent = '¡Meta alcanzada!';
                    this.dom.viajesFaltantesElement.textContent = '0';
                    return;
                }
                
                // Calcular el monto sugerido para cada viaje restante
                const montoSugeridoPorViaje = dineroRestante / viajesRestantes;
                
                // Ajustar el rango sugerido (90% - 120% del monto ideal)
                const montoSugeridoMin = montoSugeridoPorViaje * 0.90;
                const montoSugeridoMax = montoSugeridoPorViaje * 1.20;
            
                // Asegurarse de que el monto mínimo no sea menor que el 70% del costo promedio
                const montoMinimoAjustado = Math.max(montoSugeridoMin, this.costoPromedio * 0.7);
                
                this.dom.sugerenciaMontoElement.textContent = `$${montoMinimoAjustado.toFixed(2)} - $${montoSugeridoMax.toFixed(2)}`;
                this.dom.viajesFaltantesElement.textContent = viajesRestantes;
            }
            
            // Actualizar estadísticas
            actualizarEstadisticas() {
                // Calcular el total de viajes equivalentes realizados
                const viajesRealizados = this.viajes.reduce((total, viaje) => total + (viaje.multiplicador || 0), 0);
                
                // Actualizar UI
                this.dom.viajesRealizadosElement.textContent = viajesRealizados;
                this.dom.dineroAcumuladoElement.textContent = `$${this.totalAcumulado.toFixed(2)}`;
            }
            
            // Actualizar la lista de viajes optimizada
            actualizarListaViajes() {
                this.dom.listaViajesElement.innerHTML = '';
                
                if (this.viajes.length === 0) {
                    this.dom.listaViajesElement.innerHTML = `
                        <div style="text-align: center; color: var(--gray); padding: 20px;">
                            <i class="fas fa-taxi" style="font-size: 40px; margin-bottom: 10px;"></i>
                            <p>No hay viajes registrados aún</p>
                        </div>
                    `;
                    return;
                }
                
                // Ordenar viajes por timestamp (más recientes primero)
                this.viajes.sort((a, b) => b.timestamp - a.timestamp);
                
                // Usar DocumentFragment para mejor performance
                const fragment = document.createDocumentFragment();
                
                this.viajes.forEach((viaje, index) => {
                    const viajeElement = document.createElement('div');
                    viajeElement.className = viaje.tipo === 'saldo' ? 'trip-item trip-with-saldo' : 'trip-item';
                    
                    // Añadir indicador visual para viajes con multiplicador
                    const multiplicadorBadge = viaje.multiplicador > 1 ? 
                        `<span style="font-size: 10px; background: var(--warning); color: white; padding: 2px 5px; border-radius: 10px; margin-left: 5px;">x${viaje.multiplicador}</span>` : '';
                    
                    if (viaje.tipo === 'saldo') {
                        viajeElement.innerHTML = `
                            <div class="trip-info">
                                <span class="trip-number">Viaje #${this.viajes.length - index} ${multiplicadorBadge}</span>
                                <span class="trip-time">${viaje.hora}</span>
                            </div>
                            <span class="trip-amount" style="color: var(--warning);">Viaje con saldo</span>
                        `;
                    } else {
                        viajeElement.innerHTML = `
                            <div class="trip-info">
                                <span class="trip-number">Viaje #${this.viajes.length - index} ${multiplicadorBadge}</span>
                                <span class="trip-time">${viaje.hora}</span>
                            </div>
                            <span class="trip-amount">$${viaje.monto.toFixed(2)}</span>
                        `;
                    }
                    fragment.appendChild(viajeElement);
                });
                
                this.dom.listaViajesElement.appendChild(fragment);
            }
            
            // Función auxiliar para mostrar notificaciones optimizada
            mostrarNotificacion(mensaje, tipo = 'success') {
                // Crear elemento de notificación
                const notificacion = document.createElement('div');
                notificacion.className = `notification notification-${tipo}`;
                
                // Configurar icono según el tipo
                const iconos = {
                    success: 'check-circle',
                    error: 'exclamation-triangle',
                    warning: 'exclamation-circle'
                };
                
                notificacion.innerHTML = `
                    <div class="notification-content">
                        <i class="fas fa-${iconos[tipo] || 'info-circle'}"></i>
                        <span>${mensaje}</span>
                    </div>
                    <button class="notification-close">&times;</button>
                `;
                
                document.body.appendChild(notificacion);
                
                // Animación de entrada
                requestAnimationFrame(() => {
                    notificacion.classList.add('show');
                });
                
                // Configurar cierre
                const closeBtn = notificacion.querySelector('.notification-close');
                closeBtn.addEventListener('click', () => {
                    notificacion.classList.remove('show');
                    setTimeout(() => {
                        if (notificacion.parentNode) {
                            notificacion.parentNode.removeChild(notificacion);
                        }
                    }, 300);
                });
                
                // Auto-remover después de 4 segundos
                setTimeout(() => {
                    if (notificacion.parentNode) {
                        notificacion.classList.remove('show');
                        setTimeout(() => {
                            if (notificacion.parentNode) {
                                notificacion.parentNode.removeChild(notificacion);
                            }
                        }, 300);
                    }
                }, 4000);
            }
            
            // Helper para obtener clave del día
            getDayKey(date) {
                return `${date.getDate()}-${date.getMonth()}-${date.getFullYear()}`;
            }
            
            // Guardar valores en localStorage optimizado
            guardarValores() {
                const datos = {
                    metaDiaria: this.metaDiaria,
                    metaMensual: this.metaMensual,
                    costoPromedio: this.costoPromedio,
                    tiempoPromedioViaje: this.tiempoPromedioViaje,
                    viajes: this.viajes,
                    totalAcumulado: this.totalAcumulado,
                    saldoAcumulado: this.saldoAcumulado,
                    diasDescanso: this.diasDescanso,
                    diasTrabajados: this.diasTrabajados,
                    totalGanar: parseFloat(this.dom.totalGanarInput.value),
                    horasDisponibles: parseFloat(this.dom.horasDisponiblesInput.value)
                };
                
                // Guardar por mes y año para tener configuraciones individuales
                localStorage.setItem(`calculadoraUber_${this.currentMonth}_${this.currentYear}`, JSON.stringify(datos));
            }
            
            // Cargar valores desde localStorage
            cargarValoresGuardados() {
                // Cargar datos de la calculadora para el mes y año actual
                const datosGuardados = localStorage.getItem(`calculadoraUber_${this.currentMonth}_${this.currentYear}`);
                
                if (datosGuardados) {
                    try {
                        const datos = JSON.parse(datosGuardados);
                        
                        this.dom.totalGanarInput.value = datos.totalGanar || 136.36;
                        this.dom.horasDisponiblesInput.value = datos.horasDisponibles || 8;
                        this.dom.tiempoPromedioViajeInput.value = datos.tiempoPromedioViaje || 25;
                        this.viajes = datos.viajes || [];
                        this.totalAcumulado = datos.totalAcumulado || 0;
                        this.saldoAcumulado = datos.saldoAcumulado || 0;
                        
                        // Si hay datos antiguos, mantener compatibilidad
                        if (datos.metaDiaria) this.metaDiaria = datos.metaDiaria;
                        if (datos.costoPromedio) this.costoPromedio = datos.costoPromedio;
                        
                        // Cargar datos de planificación mensual si existen
                        if (datos.metaMensual) {
                            this.metaMensual = datos.metaMensual;
                            this.dom.metaMensualInput.value = this.metaMensual;
                        }
                        
                        if (datos.diasDescanso) {
                            this.diasDescanso = datos.diasDescanso;
                        } else {
                            this.diasDescanso = [];
                        }
                        
                        if (datos.diasTrabajados) {
                            this.diasTrabajados = datos.diasTrabajados;
                        } else {
                            this.diasTrabajados = {};
                        }
                    } catch (e) {
                        console.error('Error al cargar datos guardados:', e);
                        this.inicializarValoresPorDefecto();
                    }
                } else {
                    this.inicializarValoresPorDefecto();
                }
            }

            // Inicializar valores por defecto
            inicializarValoresPorDefecto() {
                this.viajes = [];
                this.totalAcumulado = 0;
                this.saldoAcumulado = 0;
                this.diasDescanso = [];
                this.diasTrabajados = {};
                
                // Aplicar la meta mensual para calcular días laborables y meta diaria sugerida
                this.aplicarMetaMensual();
            }
            
            // Alias para guardar valores (compatibilidad)
            saveValues() {
                this.guardarValores();
            }

            // Cargar valores guardados (alias para compatibilidad)
            loadSavedValues() {
                this.cargarValoresGuardados();
            }
            
            // Monitoreo de performance
            setupPerformanceMonitoring() {
                if ('performance' in window) {
                    this.performanceMarks = new Map();
                }
            }

            startPerformanceMark(name) {
                if (this.performanceMarks) {
                    this.performanceMarks.set(name, performance.now());
                }
            }

            endPerformanceMark(name) {
                if (this.performanceMarks && this.performanceMarks.has(name)) {
                    const duration = performance.now() - this.performanceMarks.get(name);
                    // Solo mostrar en consola si es lento (más de 16ms - un frame a 60fps)
                    if (duration > 16) {
                        console.warn(`Slow operation detected: ${name} took ${duration.toFixed(2)}ms`);
                    }
                }
            }
        }

        // Inicializar la aplicación cuando se cargue la página
        document.addEventListener('DOMContentLoaded', () => {
            try {
                const calculator = new UberCalculator();
                
                // Exponer globalmente para debugging si es necesario
                window.uberCalculator = calculator;
            } catch (error) {
                console.error('Error al inicializar la aplicación:', error);
                
                // Mostrar error al usuario de forma más amigable
                const errorDiv = document.createElement('div');
                errorDiv.style.cssText = `
                    position: fixed;
                    top: 20px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: #ef4444;
                    color: white;
                    padding: 15px 20px;
                    border-radius: 8px;
                    z-index: 10000;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    max-width: 300px;
                    text-align: center;
                `;
                errorDiv.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span>Error al cargar la aplicación. Por favor, recarga la página.</span>
                    </div>
                `;
                document.body.appendChild(errorDiv);
            }
        });
    </script>
</body>
</html>
